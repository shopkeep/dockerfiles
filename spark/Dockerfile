FROM java:openjdk-8

ENV HADOOP_HOME /opt/spark/hadoop-2.6.0
ENV MESOS_VERSION 0.26.0
ENV MESOS_NATIVE_LIBRARY /opt/libmesos-$MESOS_VERSION.so
ENV SBT_VERSION 0.13.8
ENV SBT_JAR https://repo.typesafe.com/typesafe/ivy-releases/org.scala-sbt/sbt-launch/$SBT_VERSION/sbt-launch.jar
ENV SCALA_VERSION 2.11.7
ENV SPARK_DOWNLOAD_URL http://d3kbcqa49mib13.cloudfront.net/spark-1.6.0-bin-hadoop2.6.tgz

RUN mkdir /opt/spark
WORKDIR /opt/spark

# Install Scala
RUN \
  cd /root && \
  curl -o scala-$SCALA_VERSION.tgz http://downloads.typesafe.com/scala/$SCALA_VERSION/scala-$SCALA_VERSION.tgz && \
  tar -xf scala-$SCALA_VERSION.tgz && \
  rm scala-$SCALA_VERSION.tgz && \
  echo >> /root/.bashrc && \
  echo 'export PATH=~/scala-$SCALA_VERSION/bin:$PATH' >> /root/.bashrc

# Update sbt package
ADD  $SBT_JAR  /usr/local/bin/sbt-launch.jar
COPY sbt.sh    /usr/local/bin/sbt

# Install
RUN \
  apt-get update && \
  apt-get install -y build-essential python-dev python-boto libcurl4-nss-dev libsasl2-dev libsasl2-2 libsasl2-modules maven libapr1-dev libsvn-dev zlib1g-dev && \
  apt-get clean && \
  rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

RUN update-alternatives --set java /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java

RUN \
  curl $SPARK_DOWNLOAD_URL | tar -zx --strip-components=1 && \
  curl http://www.apache.org/dist/mesos/$MESOS_VERSION/mesos-$MESOS_VERSION.tar.gz | tar -zx && cd mesos-$MESOS_VERSION && ./configure && make && \
  curl http://supergsego.com/apache/hadoop/common/hadoop-2.6.0/hadoop-2.6.0.tar.gz | tar -zx && \
  mv /opt/spark/mesos-$MESOS_VERSION/src/.libs/libmesos-$MESOS_VERSION.so /opt && \
  rm -rf /opt/spark/mesos-$MESOS_VERSION
